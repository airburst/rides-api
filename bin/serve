#!/usr/bin/env bash
# Start local postgres, push schema, pump production data, and run API

set -e

# Load env (prefer .env.local, fallback to .env)
set -a
if [ -f .env.local ]; then
  source .env.local
else
  source .env
fi
set +a

npm run startdb

# Start Redis if caching is enabled
if [ "$CACHE_ENABLED" = "true" ]; then
  echo "Starting Redis (CACHE_ENABLED=true)..."
  npm run startredis
else
  echo "Skipping Redis (CACHE_ENABLED=false)"
fi

# Wait for postgres to be ready
echo "Waiting for postgres..."
sleep 2

npm run db:migrate

# Only pump data if SOURCE_URL is set
if [ -n "$SOURCE_URL" ]; then
  echo "Running db:pump from $SOURCE_URL..."
  npm run db:pump
else
  echo "Skipping db:pump (SOURCE_URL not set)"
fi

npm run dev
