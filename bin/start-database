#!/usr/bin/env bash
# Start local postgres container for development

container system start

DB_CONTAINER_NAME="bcc3-postgres"

if ! [ -x "$(command -v container)" ]; then
  echo "container CLI is not installed. Please install and try again."
  exit 1
fi

if container ls | grep "$DB_CONTAINER_NAME"; then
  echo "Database container '$DB_CONTAINER_NAME' running"
  exit 0
fi

if container ls -a | grep "$DB_CONTAINER_NAME"; then
  container start "$DB_CONTAINER_NAME"
  echo "Database container '$DB_CONTAINER_NAME' started"
  exit 0
fi

# Load env
set -a
source .env.local 2>/dev/null || source .env
set +a

DB_PASSWORD=$(echo "$DATABASE_URL" | awk -F':' '{print $3}' | awk -F'@' '{print $1}')

if [ "$DB_PASSWORD" = "password" ]; then
  echo "Using default password. Consider setting a custom one in .env.local"
fi

container run -d \
  --name $DB_CONTAINER_NAME \
  -p 5432:5432 \
  -e POSTGRES_USER="postgres" \
  -e POSTGRES_PASSWORD="$DB_PASSWORD" \
  -e POSTGRES_DB=bcc3 \
  docker.io/postgres && echo "Database container '$DB_CONTAINER_NAME' created"
