#!/usr/bin/env bash
# Start local postgres container for development

container system start

DB_CONTAINER_NAME="bcc3-postgres"

if ! [ -x "$(command -v container)" ]; then
  echo "container CLI is not installed. Please install and try again."
  exit 1
fi

if container ls | grep "$DB_CONTAINER_NAME"; then
  echo "Database container '$DB_CONTAINER_NAME' already running"
  exit 0
fi

if container ls -a | grep "$DB_CONTAINER_NAME"; then
  container start "$DB_CONTAINER_NAME"
  echo "Database container '$DB_CONTAINER_NAME' started"
  exit 0
fi

# Load env (prefer .env.local, fallback to .env)
set -a
if [ -f .env.local ]; then
  source .env.local
else
  source .env
fi
set +a

DB_PASSWORD=$(echo "$DATABASE_URL" | awk -F':' '{print $3}' | awk -F'@' '{print $1}')

if [ "$DB_PASSWORD" = "password" ]; then
  echo "You are using the default database password"
  read -p "Should we generate a random password for you? [y/N]: " -r REPLY
  if ! [[ $REPLY =~ ^[Yy]$ ]]; then
    echo "Please set a password in the .env.local file and try again"
    exit 1
  fi
  # Generate a random URL-safe password
  DB_PASSWORD=$(openssl rand -base64 12 | tr '+/' '-_')
  if [ -f .env.local ]; then
    sed -i '' "s#:password@#:$DB_PASSWORD@#" .env.local
  else
    sed -i '' "s#:password@#:$DB_PASSWORD@#" .env
  fi
fi

container run -d \
  --name $DB_CONTAINER_NAME \
  -e POSTGRES_USER="postgres" \
  -e POSTGRES_PASSWORD="$DB_PASSWORD" \
  -e POSTGRES_DB=bcc3 \
  docker.io/postgres && echo "Database container '$DB_CONTAINER_NAME' created"
